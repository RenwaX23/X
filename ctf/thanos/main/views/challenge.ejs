<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Infinity Stones</title>
    <style nonce="<%= nonce %>">
        body {
            margin: 0;
            overflow: hidden;
        }

        img {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
        }
    </style>
</head>

<body>
    <img src="/main.jpeg">

    <script nonce="<%= nonce %>">
        if (location.hash === '#PerfectlyBalanced') {
            const code = encodeURIComponent('<%= code %>');

            const urlParams = new URLSearchParams(window.location.search);

            // Power Stone
            const iframe = document.createElement('iframe');
            iframe.sandbox = 'allow-scripts';
            iframe.src = 'https://power.challenge-1225.intigriti.io/?power_stone=' + (code.substring(0, 8));
            iframe.width = '100%';
            iframe.height = '300px';
            iframe.style.border = 'none';
            document.body.appendChild(iframe);

            // Reality Stone
            const iframe3 = document.createElement('iframe');
            let iframeSrc3 = 'https://reality.challenge-1225.intigriti.io/?reality_stone=' + (code.substring(16, 24));

            if (urlParams.has('reality')) {
                iframeSrc3 += '&user=' + (urlParams.get('reality').replaceAll('&', '')) + '&action=' + (urlParams.get('action').replaceAll('&', ''));
            }
            iframe3.sandbox = 'allow-scripts';
            iframe3.src = iframeSrc3;
            iframe3.width = '100%';
            iframe3.height = '300px';
            iframe3.style.border = 'none';
            document.body.appendChild(iframe3);

            // Soul Stone
            const iframe5 = document.createElement('iframe');
            let iframeSrc5 = 'https://soul.challenge-1225.intigriti.io/?soul_stone=' + (code.substring(32, 40));
            if (urlParams.has('soul')) {
                iframeSrc5 += '&url=' + (urlParams.get('soul').replaceAll('&', ''));
            }
            iframe5.src = iframeSrc5;
            iframe5.width = '100%';
            iframe5.height = '300px';
            iframe5.style.border = 'none';
            document.body.appendChild(iframe5);

            // Space Stone
            const iframe4 = document.createElement('iframe');
            let iframeSrc4 = 'https://space.challenge-1225.intigriti.io/';

            if (urlParams.has('space')) {
                iframeSrc4 += '?debug=' + (urlParams.get('space').replaceAll('&', ''));
            }
            iframe4.sandbox = 'allow-scripts';
            iframe4.src = iframeSrc4;
            iframe4.width = '100%';
            iframe4.height = '300px';
            iframe4.style.border = 'none';
            iframe4.onload = () => {
                iframe4.contentWindow.postMessage(code.substring(24, 32), '*');
            };
            document.body.appendChild(iframe4);

            // Time Stone
            const iframe6 = document.createElement('iframe');
            iframe6.sandbox = '';
            iframe6.src = 'https://time.challenge-1225.intigriti.io/?time_stone=' + (code.substring(40, 48));
            iframe6.width = '100%';
            iframe6.height = '300px';
            iframe6.style.border = 'none';
            document.body.appendChild(iframe6);

            // Mind Stone
            const iframe2 = document.createElement('iframe');
            let iframeSrc = 'https://mind.challenge-1225.intigriti.io/?mind_stone=' + (code.substring(8, 16));

            if (urlParams.has('mind')) {
                iframeSrc += '&query=' + (urlParams.get('mind').replaceAll('&', ''));
            }
            iframe2.sandbox = 'allow-scripts';
            iframe2.src = iframeSrc;
            iframe2.width = '100%';
            iframe2.height = '300px';
            iframe2.style.border = 'none';
            document.body.appendChild(iframe2);

            setTimeout(() => {
              document.body.innerHTML = '<img src="/bye.jpeg">';
            }, 3000);

            const messageListener = (event) => {
                if (typeof event.data === 'string' && event.data.substring(0, 48) === code) {
                    eval(event.data.substring(48));
                }
                window.removeEventListener('message', messageListener);
            };
            window.addEventListener('message', messageListener);

            setTimeout(() => {
                if (window.opener) {
                    window.opener.postMessage('You Lose', '*');
                };
                setTimeout(() => {
                    window.removeEventListener('message', messageListener);
                }, 10);
            }, 60000);
        }
    </script>
</body>

</html>